# This file is autogenerated by maturin v1.4.0
# To update, run
#
#    maturin generate-ci github -m s3-ops-rust-lib/Cargo.toml
#
name: CI

on:
  push:
    branches:
      - main
      - master
      - feat/build-on-mac
    tags:
      - "*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::331282901948:role/github-actions
          aws-region: ap-northeast-1
      - name: Install Cargo Lambda
        uses: jaxxstorm/action-install-gh-release@v1.9.0
        with:
          repo: cargo-lambda/cargo-lambda
          platform: linux
          arch: x86_64
      - uses: aws-actions/setup-sam@v2
      - name: Build Library
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --zig --strip --out .rust-lib --find-interpreter --manifest-path s3-ops-rust-lib/Cargo.toml
          sccache: "true"
          manylinux: auto
      - name: Deploy extension
        shell: bash
        run: |
          cargo lambda build --manifest-path analytics-extension/Cargo.toml --extension --release
          cargo lambda deploy --manifest-path analytics-extension/Cargo.toml --extension
      
      - name: Build App
        shell: bash
        run: |
          cd s3-admin-app && sam build --no-cached && sam deploy